"use strict";const WPFormsGeolocationMapboxAPI=window.WPFormsGeolocationMapboxAPI||function(a,s){const n=[],r={getFirstFeature:function(e){return e&&Object.prototype.hasOwnProperty.call(e,"features")&&e.features.length?e.features.shift():null},getFeatureProperties:function(e){return Object.prototype.hasOwnProperty.call(e,"properties")?e.properties:null},getFeatureProperty:function(e,t){e=r.getFeatureProperties(e);return Object.prototype.hasOwnProperty.call(e,t)?["region_code","country_code"].includes(t)?e[t].toUpperCase():e[t]:""},getFeatureCoordinates:function(e){return Object.prototype.hasOwnProperty.call(e,"geometry")&&Object.prototype.hasOwnProperty.call(e.geometry,"coordinates")?{lng:e.geometry.coordinates[0],lat:e.geometry.coordinates[1]}:wpforms_geolocation_settings.default_location},prepareProperties:function(e){const o={};return e.context.forEach(function(e){var t=e.id.split(".")[0];o[t]=e.text,Object.prototype.hasOwnProperty.call(e,"short_code")&&(o[t+"_code"]=e.short_code.replace(/^US-/,""))}),Object.prototype.hasOwnProperty.call(e,"text")&&(o.address_line1=e.text),Object.prototype.hasOwnProperty.call(e,"address")&&(o.address_line1+=" "+e.address),Object.prototype.hasOwnProperty.call(e,"place_name")&&(o.place_name=e.place_name),o}},o={receivePlace:function(e,t){const o=new XMLHttpRequest,a=new URL(`https://api.mapbox.com/geocoding/v5/mapbox.places/${e.lng},${e.lat}.json`);a.searchParams.set("access_token",wpforms_geolocation_settings.autocompleteSettings.common.access_token),a.searchParams.set("limit","1"),a.searchParams.set("type","address"),o.onreadystatechange=function(){var e;4===o.readyState&&200===o.status&&(e=JSON.parse(o.responseText),e=r.getFirstFeature(e))&&(e.properties=r.prepareProperties(e),t(e))},o.open("GET",a.toString()),o.send()}},i={getStateCoordinates:function(e,t){return e.settings.autocompleteSettings.strict&&(e=e.settings.autocompleteSettings.strict.toString().toLowerCase(),Object.prototype.hasOwnProperty.call(wpforms_geolocation_settings.states,e))&&Object.prototype.hasOwnProperty.call(wpforms_geolocation_settings.states[e],t)?wpforms_geolocation_settings.states[e][t]:null}},c={init:function(){"loading"===a.readyState?a.addEventListener("DOMContentLoaded",c.ready):c.ready()},ready:function(){c.getFields(),n.length&&(a.onwpformsProcessConditionalsField=function(e,t,o){t=a.getElementById("wpforms-"+t+"-field_"+o);t&&t.hasAttribute("data-autocomplete")&&s.dispatchEvent(new Event("resize"))},n.forEach(function(e){c.initMap(e),c.initAutocomplete(e)}),c.detectGeolocation())},showDebugMessage:function(e){s.location.hash&&"#wpformsdebug"===s.location.hash&&console.log(e)},getFields:function(){Array.prototype.slice.call(a.querySelectorAll('.wpforms-form .wpforms-field input[type="text"][data-autocomplete="1"]')).forEach(function(e){var t=e.closest(".wpforms-field"),o=e.hasAttribute("data-display-map")?t.querySelector(".wpforms-geolocation-map"):null,a=t.classList[1]?t.classList[1].replace("wpforms-field-",""):"text";let s={};"address"===a&&(s={address_line1:t.querySelector(".wpforms-field-address-address1"),address_line2:t.querySelector(".wpforms-field-address-address2"),place:t.querySelector(".wpforms-field-address-city"),postcode:t.querySelector(".wpforms-field-address-postal"),country_code:t.querySelector(".wpforms-field-address-country")},"SELECT"===(t=t.querySelector(".wpforms-field-address-state")).tagName?s.region_code=t:s.region=t),n.push({searchField:e,mapField:o,type:a,additionalFields:s,settings:c.getFieldSettings(e)})})},getFieldSettings:function(e){e=e.getAttribute("id").replaceAll("-","_");return{autocompleteSettings:c.getFieldAutocompleteSettings(e),mapSettings:c.getFieldMapSettings(e),markerSettings:c.getFieldMarkerSettings(e)}},getFieldAutocompleteSettings:function(e){return Object.assign({},wpforms_geolocation_settings.autocompleteSettings.common||{},wpforms_geolocation_settings.autocompleteSettings[e]||{})},getFieldMapSettings:function(e){return Object.assign({trackResize:!0},wpforms_geolocation_settings.mapSettings.common||{},wpforms_geolocation_settings.mapSettings[e]||{})},getFieldMarkerSettings:function(e){return Object.assign({draggable:!0},wpforms_geolocation_settings.markerSettings.common||{},wpforms_geolocation_settings.markerSettings[e]||{})},initMap:function(t){var e,o,a;t.mapField&&(mapboxgl.accessToken=wpforms_geolocation_settings.autocompleteSettings.common.access_token,t.map=new mapboxgl.Map(Object.assign({container:t.mapField},t.settings.mapSettings)),t.map.addControl(new mapboxgl.NavigationControl),t.marker=new mapboxgl.Marker(t.settings.markerSettings).setLngLat([t.settings.mapSettings.center.lng,t.settings.mapSettings.center.lat]).addTo(t.map),t.marker.on("dragend",c.markerChanged),e=new MutationObserver(function(e){e.forEach(function(){t.map.resize()})}),a=(o=t.mapField).closest(".wpforms-page"),e.observe(o.parentElement,{attributes:!0,attributeFilter:["style"]}),a)&&e.observe(a,{attributes:!0,attributeFilter:["style"]})},updateMap:function(e,t){e.map&&e.marker&&(t=r.getFeatureCoordinates(t),e.marker.setLngLat([t.lng,t.lat]),e.map.setCenter([t.lng,t.lat]))},markerChanged:function(){const t=c.findFieldPlaceBy("map",this._map);t&&o.receivePlace(this.getLngLat(),function(e){c.updateMap(t,e),c.updateFields(t,e)})},findFieldPlaceBy:function(t,o){let a=null;return n.some(function(e){if(Object.prototype.hasOwnProperty.call(e,t)&&e[t]===o||e.additionalFields&&Object.prototype.hasOwnProperty.call(e.additionalFields,t)&&e.additionalFields[t]===o)return a=e,!0}),a},initAutocomplete:function(e){mapboxsearch.config.accessToken=wpforms_geolocation_settings.autocompleteSettings.common.access_token;var t=a.createElement("mapbox-address-autofill");t.append(e.searchField.cloneNode(!0)),e.searchField.replaceWith(t),t.accessToken=wpforms_geolocation_settings.autocompleteSettings.common.access_token,t.options=e.settings.autocompleteSettings,e.autocomplete=t,e.searchField=t.querySelector("input"),e.autocomplete.addEventListener("retrieve",c.updateFieldPlace),e.autocomplete.addEventListener("keydown",c.preventSubmitOnPressEnter),-1!==navigator.userAgent.indexOf("Chrome")&&e.searchField.setAttribute("autocomplete","chrome-off"),"address"===e.type&&(e.additionalFields.address_line1=e.searchField,c.bindAddressFieldEvents(e))},bindAddressFieldEvents:function(e){var t;e.additionalFields.country_code&&e.additionalFields.country_code.addEventListener("change",c.updateCountry),e.settings.autocompleteSettings.strict&&(t=Array.isArray(e.settings.autocompleteSettings.strict)?e.settings.autocompleteSettings.strict.shift():e.settings.autocompleteSettings.strict,e.settings.autocompleteSettings.strict=t,e.autocomplete.options.country=t.toString().toUpperCase(),e.additionalFields.region_code.addEventListener("change",c.updateArea))},updateFieldPlace:function(e){var t=c.findFieldPlaceBy("autocomplete",e.target);t&&(e=r.getFirstFeature(e.detail),c.updateFields(t,e),c.updateMap(t,e))},preventSubmitOnPressEnter:function(e){13===e.keyCode&&e.target.ariaExpanded&&e.stopPropagation()},updateFields:function(e,t){"text"===e.type?c.updateTextField(e,t):"address"===e.type&&c.updateAddressField(e,t),c.showDebugMessage("Fields was updated"),c.showDebugMessage(e),c.showDebugMessage(t)},updateTextField:function(e,t){e.searchField.value=r.getFeatureProperty(t,"place_name"),c.triggerEvent(e.searchField,"change")},updateAddressField:function(e,t){c.clearAdditionalFields(e);for(var[o,a]of Object.entries(e.additionalFields))a&&(o=r.getFeatureProperty(t,o))&&(c.isConversationalSelect(a)?c.updateConversationalSelect(a,o):(a.value=o,c.triggerEvent(a,"change")))},isConversationalSelect:function(e){return"SELECT"===e.tagName&&Boolean(e.closest(".wpforms-conversational-select"))},updateConversationalSelect:function(e,t){var o=e.closest(".wpforms-conversational-select"),a=e.querySelector('option[value="'+t+'"]'),o=o.querySelector(".wpforms-conversational-form-dropdown-input input");e.value=t,a&&o&&(o.value=a.innerText)},triggerEvent:function(e,t){t=new Event(t,{bubbles:!0,cancelable:!0});e.dispatchEvent(t)},clearAdditionalFields:function(e){e.additionalFields&&Object.values(e.additionalFields).forEach(function(e){e&&(e.value="")})},updateCountry:function(){var e=c.findFieldPlaceBy("country_code",this),t=this.value.toString().toUpperCase();e&&e.autocomplete&&(e.autocomplete.options.country=t,c.showDebugMessage("Autocomplete field restrict to country: "+t))},updateArea:function(){var e=c.findFieldPlaceBy("region_code",this),t=this.value.toString().toUpperCase(),o=i.getStateCoordinates(e,t);c.showDebugMessage("Autocomplete field try to find the "+t+" state"),e&&t&&o||c.showDebugMessage("Autocomplete field doesn't restrict to the "+t+" state"),e.autocomplete.options.proximity=o,c.showDebugMessage("Autocomplete field restrict to the "+t+" state")},detectGeolocation:function(){wpforms_geolocation_settings.current_location&&navigator.geolocation&&n&&navigator.geolocation.getCurrentPosition(function(e){e={lat:e.coords.latitude.toFixed(6),lng:e.coords.longitude.toFixed(6)};o.receivePlace(e,function(t){n.forEach(function(e){e.searchField.closest(".wpforms-field").classList.contains("wpforms-conditional-hide")||(c.updateMap(e,t),c.updateFields(e,t))})})})}};return c}(document,window);WPFormsGeolocationMapboxAPI.init();